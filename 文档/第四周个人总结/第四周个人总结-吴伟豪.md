# 第四周总结-吴伟豪

> 本周依然是项目组的编码阶段，我负责的工作仍然是vmd部分的转换工作

本周我进行的主要工作是探究MMD中控制人物骨骼旋转与位移的机制，并尝试将导出的中间动作文件（json文件）中的数据在MMD中重现，其中主要处理的是骨骼点的旋转计算问题。

##### 1. 探索MMD中人物的动作控制机制

在MMD中，一共有两种关节点，一种是普通的关节点，控制躯干的旋转，另一种是IK骨，除了有普通关节的作用外，还有牵一发而动全身的作用，以左足IK骨为例，左足IK骨对应的是左脚踝关节，通过设置左足IK骨的位置，可以控制整个左腿（包括左膝关节，左脚尖）的位置。

在MMD中，人物上半身是没有IK骨的，上半身的根节点是大概在肚子的位置，通过每个关节点的旋转来控制上半身的运动，和unity中计算人物旋转的方法一致，较为简单。对于下半身，是有IK骨的（左足IK，右足IK，センター），下半身的根节点与上半身的关节点的位置相近，MMD对于下半身的控制较为复杂，大概的思路是通过IK骨的位置和人体关节点的生理约束来确定与该IK骨有关的整段骨头（比如整个左腿）的位置，然后再通过该段骨头上每个关节点的旋转角度来做微调。具体的机制我也没有搞清楚，考虑到项目的时间限制，我并没有在这里做深究，而是选择放弃。

##### 2. 计算MMD中的旋转

通过分析，发现openMMD导出的json文件中骨骼点的坐标系与MMD中的坐标系并不一样，需要计算两个坐标系的旋转四元数，然后通过将该四元数与json中的骨骼坐标的乘积来得到MMD中对应的坐标。在得到MMD中的坐标后，需要计算每个关节点的旋转角度，这里需要注意的是每个关节点都有自己的坐标系，并且会受到上一层关节点的坐标系的影响。计算旋转角度的方法大概如下，以计算上半身躯干的旋转为例，计算从胯部到颈部的一个向量，再计算从左肩到右肩的一个向量，然后两个向量叉乘得到垂直于身体向前的一个向量，然后通过该向量与向上的向量确定一个三维空间下的朝向，再计算该朝向与初始朝向的旋转四元数即可。这是顶层关节点的旋转角度计算，对于下一层的关节点的旋转四元数，在进行上述计算步骤后，需要左乘上一层关节点的旋转四元数的反转来得到该关节点的坐标系下的旋转四元数。

##### 3. MMD中的关于IK骨的计算

本来以为由json的空间坐标推导出IK骨的位置会比较简单，因为两者都是空间坐标，但当我深入去探索之后，发现IK骨的空间坐标计算远比旋转的计算要复杂。先不考虑IK骨牵连的骨头的旋转，在仅仅考虑IK骨的空间坐标的情况下，我们就可以完成大部分的腿部动作的实现，但IK骨的空间坐标并没有想象中的那么好算。

我们要考虑到原视频中人物的腿长与MMD中使用的模型的腿长的缩放系数，这是个不好确定的参数。首先MMD中人物模型的脚长是个不确定因素，因为不同模型的腿长会不一样，其次，在对openMMD导出的json数据进行分析后，发现即使在使用三脚架来拍摄较为稳定的视频的情况下，人物的腿长也并不是一个稳定的数值。即使在我们取站定不动的情况下的前几十帧的平均值作为腿长的情况下，并设置在一定的波动范围内不考虑变化，仍然会有一些比较突兀的数据会让模型动起来，而我们无法仅通过一个坐标点的信息来区别突兀的数据和抬腿等正常的动作，所以我们不能简单地剔除掉突兀的点。

我有想过一些解决办法，例如计算膝盖旋转的角度来辅助判断，但这并不好实现，而且还有x轴的突兀数据，z轴的突兀数据，仅仅靠一两个关节的旋转角度并不好做出判断。于是我想到，我们可以通过整个人体的空间坐标信息来判断我们当前处于一个怎样的状态（例如走路，转身，跳，蹲等），然后给IK骨输入相对的坐标信息来实现MMD中模型的动作（即输入预先设置的坐标组合），但这需要大量的工作，并不是我一个人能在短时间内完成的。

考虑到项目开发所剩的时间已经不多，对于上半身的旋转还有优化工作要做，再考虑到下半身对IK骨有关的计算问题十分复杂，在与组长商量后，我们决定放弃。